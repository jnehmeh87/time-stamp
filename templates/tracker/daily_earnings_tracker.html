{% extends "base.html" %}
{% load tracker_tags %}
{% load static %}

{% block title %}Daily Earnings Tracker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/daily_earnings_tracker.css' %}">
{% endblock %}

{% block content %}
<h1>Daily Earnings Tracker</h1>
<p class="lead">Visualize your daily earnings for a specific project and date range.</p>

<div class="mb-3 text-center text-md-start">
    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
        <i class="fas fa-filter me-1"></i> Select Project and Date Range <span id="collapse-icon"></span>
    </button>
</div>

<div class="collapse" id="filterCollapse">
    <div class="card card-body mb-4">
        <form method="get" id="trackerForm">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                    {{ form.category }}
                </div>
                <div class="col-md-3">
                    <label for="{{ form.project.id_for_label }}" class="form-label">Project</label>
                    {{ form.project }}
                </div>
                <div class="col-md-2">
                    <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date</label>
                    {{ form.start_date }}
                </div>
                <div class="col-md-2">
                    <label for="{{ form.end_date.id_for_label }}" class="form-label">End Date</label>
                    {{ form.end_date }}
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Load Project Data</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if project and project.hourly_rate %}
<div class="card mt-4">
    <div class="card-header">
        <h4>Summary for {{ project.name }}</h4>
        <small class="text-muted">For the period {{ form.start_date.value }} to {{ form.end_date.value }}</small>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title">Total Hours</h5>
                        <p class="card-text display-6">{{ total_hours|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 border-success">
                    <div class="card-body">
                        <h5 class="card-title">Gross Pay</h5>
                        <p class="card-text display-6">{{ gross_pay|floatformat:2 }} SEK</p>
                        <small class="text-muted">@ {{ hourly_rate|floatformat:2 }} SEK/hr</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 border-danger">
                    <div class="card-body">
                        <h5 class="card-title">Net Pay</h5>
                        <p class="card-text display-6">{{ net_pay|floatformat:2 }} SEK</p>
                        <small class="text-muted">After social fees & income tax</small>
                    </div>
                </div>
            </div>
        </div>

        <h5 class="mt-4">Daily Earnings Chart</h5>
        <hr>
        {% if chart_labels %}
        <canvas id="dailyEarningsChart"></canvas>
        {% else %}
        <div class="alert alert-info">No time entries found for this project in the selected date range.</div>
        {% endif %}
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5>Time Entries Included</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped responsive-table">
                <thead>
                    <tr>
                        <th class="text-center">Date</th>
                        <th class="text-center">Title</th>
                        <th class="text-center">Time Details</th>
                        <th class="text-center">Pause Duration</th>
                        <th class="text-center">Worked Duration</th>
                        <th class="text-center">Price per Entry</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries %}
                    <tr>
                        <td data-label="Date" class="text-center">{{ entry.start_time|date:"Y-m-d" }}</td>
                        <td data-label="Title" class="text-center">{{ entry.title }}</td>
                        <td data-label="Time Details" class="text-center">{{ entry.start_time|date:"g:i A" }} - {{ entry.end_time|date:"g:i A" }}</td>
                        <td data-label="Pause Duration" class="text-center">{{ entry.paused_duration|human_duration }}</td>
                        <td data-label="Worked Duration" class="text-center">{{ entry.worked_duration|human_duration }}</td>
                        <td data-label="Price" class="text-center">{% calculate_entry_price entry hourly_rate as entry_price %}{{ entry_price }} SEK</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No time entries found for this period.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% elif request.GET.project %}
<div class="alert alert-info mt-4">
    Please select a project and a date range to view daily earnings. The selected project must have an hourly rate set.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ chart_labels|json_script:"chart-labels" }}
{{ chart_data|json_script:"chart-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/daily_earnings_tracker.js' %}"></script>
{% endblock %}
