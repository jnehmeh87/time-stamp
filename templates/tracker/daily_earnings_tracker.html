{% extends "base.html" %}
{% load tracker_tags %}

{% block title %}Daily Earnings Tracker{% endblock %}

{% block extra_css %}
<style>
@media (max-width: 767.98px) {
    .responsive-table thead {
        display: none;
    }
    .responsive-table tbody, .responsive-table tr, .responsive-table td {
        display: block;
        width: 100%;
    }
    .responsive-table tr {
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
        border-radius: .25rem;
    }
    .responsive-table td {
        text-align: right;
        padding-left: 50%;
        position: relative;
        border: none;
        border-bottom: 1px solid #dee2e6;
    }
    .responsive-table td:last-child {
        border-bottom: none;
    }
    .responsive-table td::before {
        content: attr(data-label);
        position: absolute;
        left: .75rem;
        font-weight: bold;
        text-align: left;
    }
}
</style>
{% endblock %}

{% block content %}
<h1>Daily Earnings Tracker</h1>
<p class="lead">Visualize your daily earnings for a specific project and date range.</p>

<div class="mb-3 text-center text-md-start">
    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
        <i class="fas fa-filter me-1"></i> Select Project and Date Range <span id="collapse-icon"></span>
    </button>
</div>

<div class="collapse" id="filterCollapse">
    <div class="card card-body mb-4">
        <form method="get" id="trackerForm">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                    {{ form.category }}
                </div>
                <div class="col-md-3">
                    <label for="{{ form.project.id_for_label }}" class="form-label">Project</label>
                    {{ form.project }}
                </div>
                <div class="col-md-2">
                    <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date</label>
                    {{ form.start_date }}
                </div>
                <div class="col-md-2">
                    <label for="{{ form.end_date.id_for_label }}" class="form-label">End Date</label>
                    {{ form.end_date }}
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Load Project Data</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if project %}
<div class="card mt-4">
    <div class="card-header">
        <h4>Summary for {{ project.name }}</h4>
        <small class="text-muted">For the period {{ form.start_date.value }} to {{ form.end_date.value }}</small>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title">Total Hours</h5>
                        <p class="card-text display-6">{{ total_hours|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 border-success">
                    <div class="card-body">
                        <h5 class="card-title">Gross Pay</h5>
                        <p class="card-text display-6">{{ gross_pay|floatformat:2 }} SEK</p>
                        <small class="text-muted">@ {{ hourly_rate|floatformat:2 }} SEK/hr</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 border-danger">
                    <div class="card-body">
                        <h5 class="card-title">Net Pay</h5>
                        <p class="card-text display-6">{{ net_pay|floatformat:2 }} SEK</p>
                        <small class="text-muted">After social fees & income tax</small>
                    </div>
                </div>
            </div>
        </div>

        <h5 class="mt-4">Daily Earnings Chart</h5>
        <hr>
        {% if chart_labels %}
        <canvas id="dailyEarningsChart"></canvas>
        {% else %}
        <div class="alert alert-info">No time entries found for this project in the selected date range.</div>
        {% endif %}
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5>Time Entries Included</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped responsive-table">
                <thead>
                    <tr>
                        <th class="text-center">Date</th>
                        <th class="text-center">Title</th>
                        <th class="text-center">Time Details</th>
                        <th class="text-center">Pause Duration</th>
                        <th class="text-center">Worked Duration</th>
                        <th class="text-center">Price per Entry</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries %}
                    <tr>
                        <td data-label="Date" class="text-center">{{ entry.start_time|date:"Y-m-d" }}</td>
                        <td data-label="Title" class="text-center">{{ entry.title }}</td>
                        <td data-label="Time Details" class="text-center">{{ entry.start_time|date:"g:i A" }} - {{ entry.end_time|date:"g:i A" }}</td>
                        <td data-label="Pause Duration" class="text-center">{{ entry.paused_duration|human_duration }}</td>
                        <td data-label="Worked Duration" class="text-center">{{ entry.worked_duration|human_duration }}</td>
                        <td data-label="Price" class="text-center">{% calculate_entry_price entry hourly_rate as entry_price %}{{ entry_price }} SEK</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No time entries found for this period.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% elif request.GET.project %}
<div class="alert alert-info mt-4">
    Please select a project and a date range to view daily earnings. The selected project must have an hourly rate set.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ chart_labels|json_script:"chart-labels" }}
{{ chart_data|json_script:"chart-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- New logic for the filter button ---
    const filterCollapse = document.getElementById('filterCollapse');
    const filterButton = document.querySelector('[data-bs-target="#filterCollapse"]');
    const collapseIcon = document.getElementById('collapse-icon');

    const updateButton = () => {
        const isExpanded = filterButton.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
            filterButton.classList.remove('btn-primary');
            filterButton.classList.add('btn-secondary');
            collapseIcon.textContent = '-';
        } else {
            filterButton.classList.remove('btn-secondary');
            filterButton.classList.add('btn-primary');
            collapseIcon.textContent = '+';
        }
    };

    if (filterCollapse) {
        filterCollapse.addEventListener('shown.bs.collapse', updateButton);
        filterCollapse.addEventListener('hidden.bs.collapse', updateButton);
        // Set initial state
        updateButton();
    }

    // Logic for project date filtering
    const categorySelect = document.getElementById('id_category');
    const projectSelect = document.getElementById('id_project');

    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            projectSelect.value = '';
            const url = new URL(window.location);
            url.searchParams.set('category', this.value);
            url.searchParams.delete('project');
            // Keep other params
            url.searchParams.delete('start_date');
            url.searchParams.delete('end_date');
            window.location.href = url.toString();
        });
    }

    // Chart.js implementation
    try {
        const labels = JSON.parse(document.getElementById('chart-labels').textContent);
        const data = JSON.parse(document.getElementById('chart-data').textContent);

        if (labels.length > 0) {
            const ctx = document.getElementById('dailyEarningsChart').getContext('2d');
            const dailyEarningsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Earnings (SEK)',
                        data: data,
                        backgroundColor: 'rgba(0, 123, 255, 0.5)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return value + ' SEK';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('sv-SE', { style: 'currency', currency: 'SEK' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (e) {
        // Fail silently if chart data is not available or malformed
        console.error("Could not render chart:", e);
    }
});
</script>
{% endblock %}
