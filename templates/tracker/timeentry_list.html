{% extends "base.html" %}
{% load tracker_tags %}

{% block title %}My Time Entries{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>My Time Entries</h1>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="btn-group" role="group" aria-label="View switcher">
            <button type="button" class="btn btn-outline-secondary active" id="table-view-btn" title="List View">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-ul" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/></svg>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="card-view-btn" title="Card View">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-3x2-gap-fill" viewBox="0 0 16 16"><path d="M1 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1zM1 9a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1z"/></svg>
            </button>
        </div>
    </div>
</div>


<!-- Desktop Filter (Visible on LG screens and up) -->
<div class="card mb-4 d-none d-lg-block">
    <div class="card-header">Filters</div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-lg-2">
                <label for="category_desktop" class="form-label">Category</label>
                <select name="category" id="category_desktop" class="form-select">
                    <option value="">All</option>
                    <option value="work" {% if form.category.value == 'work' %}selected{% endif %}>Work</option>
                    <option value="personal" {% if form.category.value == 'personal' %}selected{% endif %}>Personal</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label for="project_desktop" class="form-label">Project</label>
                <select name="project" id="project_desktop" class="form-select">
                    <option value="">All Projects</option>
                    {% for project in all_projects %}
                        <option value="{{ project.pk }}" data-category="{{ project.category }}" {% if project.pk|stringformat:"s" == form.project.value|stringformat:"s" %}selected{% endif %}>
                            {{ project.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2">
                <label for="start_date_desktop" class="form-label">Start Date</label>
                <input type="date" name="start_date" id="start_date_desktop" class="form-control" value="{{ form.start_date.value|default:'' }}">
            </div>
            <div class="col-lg-2">
                <label for="end_date_desktop" class="form-label">End Date</label>
                <input type="date" name="end_date" id="end_date_desktop" class="form-control" value="{{ form.end_date.value|default:'' }}">
            </div>
            <div class="col-lg-2">
                <div class="form-check form-switch pb-1">
                    <input class="form-check-input" type="checkbox" role="switch" name="show_archived" id="show_archived_desktop" value="on" {% if form.show_archived.value %}checked{% endif %} onchange="this.form.submit()">
                    <label class="form-check-label" for="show_archived_desktop">
                        Show Archived
                    </label>
                </div>
            </div>
            <div class="col-lg-2">
                <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
        </form>
    </div>
</div>

<!-- Mobile/Tablet Filter (Hidden on LG screens and up) -->
<div class="card mb-4 d-lg-none">
    <div class="card-header" id="filter-heading-mobile">
        <h2 class="mb-0">
            <button class="btn btn-link btn-block text-left text-decoration-none d-flex justify-content-between w-100" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse-mobile" aria-expanded="false" aria-controls="filter-collapse-mobile">
                <span class="h5 mb-0">Filters</span>
                <span class="filter-toggle-icon">+</span>
            </button>
        </h2>
    </div>
    <div id="filter-collapse-mobile" class="collapse">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-12">
                    <label for="start_date_mobile" class="form-label">Start Date</label>
                    <input type="date" name="start_date" id="start_date_mobile" class="form-control" value="{{ form.start_date.value|default:'' }}">
                </div>
                <div class="col-12">
                    <label for="end_date_mobile" class="form-label">End Date</label>
                    <input type="date" name="end_date" id="end_date_mobile" class="form-control" value="{{ form.end_date.value|default:'' }}">
                </div>
                <div class="col-12">
                    <label for="category_mobile" class="form-label">Category</label>
                    <select name="category" id="category_mobile" class="form-select">
                        <option value="">All</option>
                        <option value="work" {% if form.category.value == 'work' %}selected{% endif %}>Work</option>
                        <option value="personal" {% if form.category.value == 'personal' %}selected{% endif %}>Personal</option>
                    </select>
                </div>
                <div class="col-12">
                    <label for="project_mobile" class="form-label">Project</label>
                    <select name="project" id="project_mobile" class="form-select" 
                            data-latest-work-project="{{ latest_work_project_id|default:'' }}" 
                            data-latest-personal-project="{{ latest_personal_project_id|default:'' }}">
                        <option value="">All Projects</option>
                        {% for project in all_projects %}
                            <option value="{{ project.pk }}" data-category="{{ project.category }}" {% if project.pk|stringformat:"s" == form.project.value|stringformat:"s" %}selected{% endif %}>
                                {{ project.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" name="show_archived" id="show_archived_mobile" value="on" {% if form.show_archived.value %}checked{% endif %} onchange="this.form.submit()">
                        <label class="form-check-label" for="show_archived_mobile">
                            Show Archived
                        </label>
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form method="post" id="bulk-action-form">
    {% csrf_token %}
    <input type="hidden" name="preserved_filters" value="{{ request.GET.urlencode }}">
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2 gap-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all-entries">
                    <label class="form-check-label" for="select-all-entries">
                        Select all
                    </label>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted fst-italic me-2 d-none d-sm-inline">
                        <span title="Time was edited"><i class="fas fa-pen"></i> = Edited</span>
                        <span class="ms-2" title="Manually created"><i class="fas fa-plus-circle"></i> = Manual</span>
                    </small>
                    {% if form.show_archived.value %}
                    <button type="submit" class="btn btn-secondary archive-action-btn" id="bulk-unarchive-btn" disabled formaction="{% url 'tracker:entry_bulk_unarchive_confirm' %}">Unarchive</button>
                    {% else %}
                    <button type="submit" class="btn btn-warning archive-action-btn" id="bulk-archive-btn" disabled formaction="{% url 'tracker:entry_bulk_archive_confirm' %}">Archive</button>
                    {% endif %}
                    <button type="submit" class="btn btn-danger" id="bulk-delete-btn" disabled formaction="{% url 'tracker:entry_bulk_delete_confirm' %}">Delete</button>
                    <a href="{% url 'tracker:entry_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i> New Manual Entry
                    </a>
                </div>
            </div>
            
            <!-- Table View Container -->
            <div id="table-view-container">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr id="sortable-headers">
                                <th data-column-id="checkbox"></th><!-- Checkbox column -->
                                <th class="text-center" data-column-id="status">
                                    <a href="?{% sort_url 'is_manual' %}" class="text-decoration-none text-reset">
                                        Status {% if sort_by == 'is_manual' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="task">
                                    <a href="?{% sort_url 'title' %}" class="text-decoration-none text-reset">
                                        Task {% if sort_by == 'title' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="project">
                                     <a href="?{% sort_url 'project__name' %}" class="text-decoration-none text-reset">
                                        Project {% if sort_by == 'project__name' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="date">
                                     <a href="?{% sort_url 'start_time' %}" class="text-decoration-none text-reset">
                                        Date {% if sort_by == 'start_time' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="start_time">Time Details</th>
                                <th class="text-center" data-column-id="duration">
                                     <a href="?{% sort_url 'duration' %}" class="text-decoration-none text-reset">
                                        Duration {% if sort_by == 'duration' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="paused_time">
                                     <a href="?{% sort_url 'paused_duration' %}" class="text-decoration-none text-reset">
                                        Paused Time {% if sort_by == 'paused_duration' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="category">
                                     <a href="?{% sort_url 'category' %}" class="text-decoration-none text-reset">
                                        Category {% if sort_by == 'category' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            {% for entry in entries %}
                            <tr class="{% if entry.is_archived %}table-warning{% endif %}">
                                <td class="text-center" data-column-id="checkbox"><input class="form-check-input entry-checkbox" type="checkbox" name="selected_entries" value="{{ entry.pk }}"></td>
                                <td class="text-center" data-column-id="status">
                                    {% if entry.is_manual %}
                                        <i class="fas fa-plus-circle text-muted" title="This entry was manually created."></i>
                                    {% elif entry.was_edited %}
                                        <i class="fas fa-pencil-alt text-muted" title="This entry's time was edited."></i>
                                    {% endif %}
                                </td>
                                <td class="text-center" data-column-id="task">
                                    <a href="#" class="text-decoration-none view-details-btn" 
                                       data-entry-id="{{ entry.pk }}" 
                                       data-bs-toggle="modal" 
                                       data-bs-target="#entryDetailsModal">
                                        {{ entry.title }}
                                    </a>
                                </td>
                                <td class="text-center" data-column-id="project">{{ entry.project.name|default:"-" }}</td>
                                <td class="text-center" data-column-id="date">{{ entry.start_time|date:"D j/n/Y" }}</td>
                                <td class="text-center" data-column-id="start_time">{{ entry.start_time|date:"g:i A" }} - {{ entry.end_time|date:"g:i A" }}</td>
                                <td class="text-center" data-column-id="duration">{{ entry.duration|human_duration }}</td>
                                <td class="text-center" data-column-id="paused_time">{{ entry.paused_duration|human_duration }}</td>
                                <td class="text-center" data-column-id="category">{{ entry.get_category_display }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">No time entries found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Card View Container -->
            <div id="card-view-container" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3" style="display: none;">
                {% for entry in entries %}
                <div class="col">
                    <div class="card h-100 clickable-card view-details-btn {% if entry.is_archived %}bg-warning bg-opacity-25{% endif %}" 
                         data-entry-id="{{ entry.pk }}" 
                         data-bs-toggle="modal" 
                         data-bs-target="#entryDetailsModal">
                        {% with entry.images.first as first_image %}
                            {% if first_image %}
                                <img src="{{ first_image.image.url }}" class="card-img-top" alt="{{ entry.title }} image" style="height: 180px; object-fit: cover;">
                            {% endif %}
                        {% endwith %}
                        <div class="card-header d-flex justify-content-between align-items-start">
                            <input class="form-check-input entry-checkbox mt-1" type="checkbox" name="selected_entries" value="{{ entry.pk }}" onclick="event.stopPropagation();">
                            <div class="flex-grow-1 ms-2">
                                <h5 class="mb-0">{{ entry.title }}</h5>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <strong>Project:</strong> {{ entry.project.name|default:"-" }}<br>
                                <strong>Category:</strong> {{ entry.get_category_display }}<br>
                                <span class="badge bg-success">Duration: {{ entry.duration|human_duration }}</span>
                                {% if entry.paused_duration %}
                                  |  <span class="badge bg-warning text-dark">Pause: {{ entry.paused_duration|human_duration }}</span>
                                {% endif %}
                                {% if entry.is_manual %}
                                  | <span class="badge bg-primary text-white" title="Manually created"><i class="fas fa-plus-circle"></i> Manual</span>
                                {% elif entry.was_edited %}
                                  | <span class="badge bg-info text-dark" title="Time was edited"><i class="fas fa-pen"></i> Edited</span>
                                {% endif %}
                            </p>
                            <p class="card-text small text-muted">
                                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-calendar-event me-1" viewBox="0 0 16 16"><path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/></svg>
                                {{ entry.start_time|date:"D, j M Y" }}
                                <br>
                                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-clock me-1" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0"/></svg>
                                {{ entry.start_time|date:"g:i:s A" }} - {{ entry.end_time|date:"g:i:s A" }}
                                <br>
                            </p>
                        </div>
                    </div>
                </div>
                {% empty %}
                    <div class="col-12">
                        <p class="text-center">No time entries found.</p>
                    </div>
                {% endfor %}
            </div>

        </div>
    </div>
</form>

{% if is_paginated %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% url_replace page=1 %}" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?{% url_replace page=page_obj.previous_page_number %}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
        {% endif %}

        <li class="page-item disabled">
            <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% url_replace page=page_obj.next_page_number %}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?{% url_replace page=page_obj.paginator.num_pages %}" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Details Modal -->
<div class="modal fade" id="entryDetailsModal" tabindex="-1" aria-labelledby="entryDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="entryDetailsModalLabel">Time Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-spinner" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="modal-content-area" class="d-none">
                    <h4 id="modal-title"></h4>
                    <p>
                        <strong>Project:</strong> <span id="modal-project"></span><br>
                        <strong>Category:</strong> <span id="modal-category"></span>
                    </p>
                    <hr>
                    <p>
                        <strong>Start:</strong> <span id="modal-start-time"></span><br>
                        <strong>End:</strong> <span id="modal-end-time"></span><br>
                        <strong>Duration:</strong> <span id="modal-duration"></span><br>
                        <strong>Pause:</strong> <span id="modal-pause"></span>
                    </p>
                    <hr>
                    <h5>Description</h5>
                    <p id="modal-description"></p>
                    <h5>Notes</h5>
                    <p id="modal-notes"></p>
                    
                    <div id="modal-images-section">
                        <h5>Images</h5>
                        <div id="modal-images-gallery" class="row">
                            <!-- Images will be injected here by JS -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="modal-edit-button" class="btn btn-primary">Edit this Entry</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* --- Existing Table Styles (Preserved) --- */
.table td, .table thead th {
    vertical-align: middle; /* Vertically center all header and cell content */
}

.table thead th:first-child {
    padding: 0; /* Remove padding from the empty checkbox header cell */
}
/* Columns that should not wrap */
.table th:nth-child(2), .table td:nth-child(2), /* Status */
.table th:nth-child(3), .table td:nth-child(3), /* Title */
.table th:nth-child(4), .table td:nth-child(4), /* Project */
.table th:nth-child(7), .table td:nth-child(7), /* Image */
.table th:nth-child(8), .table td:nth-child(8), /* Date */
.table th:nth-child(9), .table td:nth-child(9), /* Start Time */
.table th:nth-child(10), .table td:nth-child(10), /* End Time */
.table th:nth-child(11), .table td:nth-child(11), /* Duration */
.table th:nth-child(12), .table td:nth-child(12) /* Category */
{
    white-space: nowrap;
}
/* Columns that can wrap but have a minimum width */
.table th:nth-child(5), .table td:nth-child(5), /* Description */
.table th:nth-child(6), .table td:nth-child(6)  /* Notes */
{
    min-width: 200px;
}

/* --- New Filter Button Styles --- */
.btn-link {
    color: var(--bs-body-color);
    padding: 0;
}
.btn-link:focus, .btn-link:hover {
    color: var(--bs-body-color);
}
.filter-toggle-icon {
    font-size: 1.5rem;
    font-weight: 300;
    line-height: 1;
    transition: transform 0.2s ease-in-out;
}
.card-header [aria-expanded="true"] .filter-toggle-icon {
    transform: rotate(45deg);
}

.clickable-card {
    cursor: pointer;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.clickable-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* --- Action Button Width Fix --- */
.archive-action-btn {
    min-width: 95px; /* Ensures both Archive and Unarchive buttons have the same width */
    text-align: center;
}

/* --- Mobile Bulk Action Button Styles --- */
@media (max-width: 575.98px) {
    #bulk-action-form .btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }
}

.table th:hover {
    cursor: grab;
}
.table th a {
    color: inherit;
    text-decoration: none;
}
.table th a:hover {
    color: inherit;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Column Reordering & Persistence ---
    const headerRow = document.getElementById('sortable-headers');
    const tableBody = document.getElementById('table-body');
    const storageKey = 'timeEntryTableColumnOrder';

    // Function to apply a specific column order
    function applyColumnOrder(order) {
        if (!order || !tableBody || !headerRow) return;
        
        const headers = Array.from(headerRow.children);
        const newHeaderOrder = order.map(id => headers.find(h => h.dataset.columnId === id)).filter(Boolean); // .filter(Boolean) removes undefined
        headerRow.replaceChildren(...newHeaderOrder);

        Array.from(tableBody.rows).forEach(row => {
            if (row.children.length > 1) { // Skip the "No entries found" row
                const cells = Array.from(row.children);
                const newCellOrder = order.map(id => cells.find(c => c.dataset.columnId === id)).filter(Boolean);
                row.replaceChildren(...newCellOrder);
            }
        });
    }

    // --- Smartly Load and Apply Column Order ---
    const savedOrder = JSON.parse(localStorage.getItem(storageKey));
    const currentColumns = Array.from(headerRow.children).map(th => th.dataset.columnId);

    // Check if the saved order is valid (same columns)
    const isOrderValid = savedOrder && savedOrder.length === currentColumns.length && savedOrder.every(id => currentColumns.includes(id));

    if (isOrderValid) {
        applyColumnOrder(savedOrder);
    } else {
        // If order is invalid or doesn't exist, clear it from storage
        localStorage.removeItem(storageKey);
    }

    // Initialize SortableJS for drag-and-drop
    if (headerRow) {
        new Sortable(headerRow, {
            animation: 150,
            onEnd: function () {
                const newOrder = Array.from(this.el.children).map(th => th.dataset.columnId);
                localStorage.setItem(storageKey, JSON.stringify(newOrder));
                applyColumnOrder(newOrder);
            }
        });
    }

    // --- View Toggler ---
    const tableViewBtn = document.getElementById('table-view-btn');
    const cardViewBtn = document.getElementById('card-view-btn');
    const tableContainer = document.getElementById('table-view-container');
    const cardContainer = document.getElementById('card-view-container');

    function setView(view) {
        if (view === 'card') {
            tableContainer.style.display = 'none';
            cardContainer.style.display = 'flex'; // Use flex for proper row wrapping
            tableViewBtn.classList.remove('active');
            cardViewBtn.classList.add('active');
            localStorage.setItem('timeEntryView', 'card');
        } else {
            tableContainer.style.display = 'block';
            cardContainer.style.display = 'none';
            tableViewBtn.classList.add('active');
            cardViewBtn.classList.remove('active');
            localStorage.setItem('timeEntryView', 'table');
        }
    }

    tableViewBtn.addEventListener('click', () => setView('table'));
    cardViewBtn.addEventListener('click', () => setView('card'));

    // Restore user's preferred view on page load, or set default based on screen size
    const preferredView = localStorage.getItem('timeEntryView');
    if (preferredView) {
        setView(preferredView);
    } else {
        // If no preference is stored, default to card view on smaller screens (Bootstrap's lg breakpoint)
        if (window.innerWidth < 992) {
            setView('card');
        } else {
            setView('table'); // Default to table view on larger screens
        }
    }

    // --- Desktop Project Filter Logic ---
    const desktopCategorySelect = document.getElementById('category_desktop');
    const desktopProjectSelect = document.getElementById('project_desktop');

    if (desktopCategorySelect && desktopProjectSelect) {
        const desktopProjectOptions = Array.from(desktopProjectSelect.options);

        function filterDesktopProjects() {
            const selectedCategory = desktopCategorySelect.value;
            const currentProject = desktopProjectSelect.value;

            desktopProjectOptions.forEach(option => {
                if (option.value === "" || selectedCategory === "" || option.dataset.category === selectedCategory) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });

            const selectedOption = desktopProjectSelect.querySelector(`option[value="${currentProject}"]`);
            if (selectedOption && selectedOption.style.display === 'none') {
                desktopProjectSelect.value = '';
            }
        }

        desktopCategorySelect.addEventListener('change', filterDesktopProjects);
        filterDesktopProjects(); // Initial filter on page load
    }

    // --- Mobile Project Filter Logic ---
    const mobileCategorySelect = document.getElementById('category_mobile');
    const mobileProjectSelect = document.getElementById('project_mobile');

    if (mobileCategorySelect && mobileProjectSelect) {
        const mobileProjectOptions = Array.from(mobileProjectSelect.options);

        function filterMobileProjects() {
            const selectedCategory = mobileCategorySelect.value;
            const currentProject = mobileProjectSelect.value;

            mobileProjectOptions.forEach(option => {
                if (option.value === "" || selectedCategory === "" || option.dataset.category === selectedCategory) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });

            // If the currently selected project is now hidden, reset to "All Projects"
            const selectedOption = mobileProjectSelect.querySelector(`option[value="${currentProject}"]`);
            if (selectedOption && selectedOption.style.display === 'none') {
                mobileProjectSelect.value = '';
            }
        }

        mobileCategorySelect.addEventListener('change', filterMobileProjects);
        // Initial filter on page load to hide projects that don't match the initial category
        filterMobileProjects();
    }

    // --- Mobile Filter Icon Toggle ---
    const filterCollapseElement = document.getElementById('filter-collapse-mobile');
    if (filterCollapseElement) {
        const toggleIcon = document.querySelector('.filter-toggle-icon');
        filterCollapseElement.addEventListener('show.bs.collapse', function () {
            toggleIcon.textContent = '−'; // Minus sign
        });
        filterCollapseElement.addEventListener('hide.bs.collapse', function () {
            toggleIcon.textContent = '+';
        });
    }

    // --- Dynamic Filter Logic ---
    function setupDynamicFilters(categorySelectEl, projectSelectEl, startDateIn, endDateIn) {
        if (!categorySelectEl || !projectSelectEl) return;

        const projectOptions = Array.from(projectSelectEl.options);

        // 1. Filter projects based on category
        categorySelectEl.addEventListener('change', function() {
            const selectedCategory = this.value;
            const currentProject = projectSelectEl.value;

            // Reset project dropdown
            projectSelectEl.innerHTML = ''; 

            projectOptions.forEach(option => {
                if (option.value === "" || selectedCategory === "" || option.dataset.category === selectedCategory) {
                    projectSelectEl.add(option.cloneNode(true));
                }
            });

            // Restore selection if possible, otherwise reset
            const selectedOption = projectSelectEl.querySelector(`option[value="${currentProject}"]`);
            if (selectedOption) {
                projectSelectEl.value = currentProject;
            } else {
                projectSelectEl.value = '';
            }
        });

        // 2. Auto-populate dates on project selection
        projectSelectEl.addEventListener('change', function() {
            const projectId = this.value;
            if (projectId) {
                fetch(`{% url 'tracker:ajax_get_project_dates' %}?project_id=${projectId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if(startDateIn) startDateIn.value = data.start_date;
                            if(endDateIn) endDateIn.value = data.end_date;
                        }
                    });
            }
        });
    }

    // Setup for desktop filters
    setupDynamicFilters(
        document.getElementById('category_desktop'),
        document.getElementById('project_desktop'),
        document.getElementById('start_date_desktop'),
        document.getElementById('end_date_desktop')
    );

    // Setup for mobile filters
    setupDynamicFilters(
        document.getElementById('category_mobile'),
        document.getElementById('project_mobile'),
        document.getElementById('start_date_mobile'),
        document.getElementById('end_date_mobile')
    );


    // --- Bulk Action Logic ---
    const selectAllCheckbox = document.getElementById('select-all-entries');
    // Select checkboxes from both views
    const entryCheckboxes = document.querySelectorAll('.entry-checkbox');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const bulkArchiveBtn = document.getElementById('bulk-archive-btn');
    const bulkUnarchiveBtn = document.getElementById('bulk-unarchive-btn');
    const bulkActionForm = document.getElementById('bulk-action-form');

    function toggleBulkActionButtons() {
        const anyChecked = Array.from(entryCheckboxes).some(cb => cb.checked);
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = !anyChecked;
        if (bulkArchiveBtn) bulkArchiveBtn.disabled = !anyChecked;
        if (bulkUnarchiveBtn) bulkUnarchiveBtn.disabled = !anyChecked;
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            entryCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            toggleBulkActionButtons();
        });
    }

    entryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (!this.checked) {
                selectAllCheckbox.checked = false;
            } else {
                const allChecked = Array.from(entryCheckboxes).every(cb => cb.checked);
                if (allChecked) {
                    selectAllCheckbox.checked = true;
                }
            }
            toggleBulkActionButtons();
        });
    });

    if (bulkActionForm) {
        bulkActionForm.addEventListener('submit', function(e) {
            const anyChecked = Array.from(entryCheckboxes).some(cb => cb.checked);
            if (!anyChecked) {
                e.preventDefault();
                alert('Please select at least one entry.');
                return;
            }
        });
    }

    toggleBulkActionButtons(); // Initial check on page load

    // --- Entry Details Modal ---
    const entryDetailsModal = document.getElementById('entryDetailsModal');
    const modalSpinner = document.getElementById('modal-spinner');
    const modalContent = document.getElementById('modal-content-area');

    entryDetailsModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const entryId = button.dataset.entryId;

        // Show spinner, hide content
        modalSpinner.classList.remove('d-none');
        modalContent.classList.add('d-none');

        fetch(`/ajax/get-entry-details/${entryId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate modal
                    document.getElementById('modal-title').textContent = data.title;
                    document.getElementById('modal-project').textContent = data.project;
                    document.getElementById('modal-category').textContent = data.category;
                    document.getElementById('modal-start-time').textContent = data.start_time;
                    document.getElementById('modal-end-time').textContent = data.end_time;
                    document.getElementById('modal-duration').textContent = data.duration;
                    document.getElementById('modal-pause').textContent = data.paused_duration;
                    document.getElementById('modal-description').textContent = data.description;
                    document.getElementById('modal-notes').textContent = data.notes;
                    document.getElementById('modal-edit-button').href = data.update_url;

                    const gallery = document.getElementById('modal-images-gallery');
                    const imagesSection = document.getElementById('modal-images-section');
                    gallery.innerHTML = ''; // Clear previous images

                    if (data.images && data.images.length > 0) {
                        data.images.forEach(img => {
                            const col = document.createElement('div');
                            col.className = 'col-md-4 mb-3';
                            col.innerHTML = `<a href="${img.url}" target="_blank"><img src="${img.url}" class="img-fluid rounded" alt="Entry Image"></a>`;
                            gallery.appendChild(col);
                        });
                        imagesSection.classList.remove('d-none');
                    } else {
                        imagesSection.classList.add('d-none');
                    }

                    // Hide spinner, show content
                    modalSpinner.classList.add('d-none');
                    modalContent.classList.remove('d-none');
                } else {
                    // Handle error
                    document.getElementById('modal-content-area').innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                    modalSpinner.classList.add('d-none');
                    modalContent.classList.remove('d-none');
                }
            });
    });
});
</script>
{% endblock %}
