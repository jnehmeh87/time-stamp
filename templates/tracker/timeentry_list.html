{% extends "base.html" %}
{% load tracker_tags %}

{% block title %}My Time Entries{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>My Time Entries</h1>
    <div class="btn-group" role="group" aria-label="View switcher">
        <button type="button" class="btn btn-outline-secondary active" id="table-view-btn" title="List View">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-ul" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/></svg>
        </button>
        <button type="button" class="btn btn-outline-secondary" id="card-view-btn" title="Card View">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-3x2-gap-fill" viewBox="0 0 16 16"><path d="M1 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1zM1 9a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1z"/></svg>
        </button>
    </div>
</div>

<!-- Desktop Filter (Visible on LG screens and up) -->
<div class="card mb-4 d-none d-lg-block">
    <div class="card-header">Filters</div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-lg-2">
                <label for="start_date_desktop" class="form-label">Start Date</label>
                <input type="date" name="start_date" id="start_date_desktop" class="form-control" value="{{ filter_form.start_date|default:'' }}">
            </div>
            <div class="col-lg-2">
                <label for="end_date_desktop" class="form-label">End Date</label>
                <input type="date" name="end_date" id="end_date_desktop" class="form-control" value="{{ filter_form.end_date|default:'' }}">
            </div>
            <div class="col-lg-2">
                <label for="category_desktop" class="form-label">Category</label>
                <select name="category" id="category_desktop" class="form-select">
                    <option value="">All</option>
                    <option value="work" {% if filter_form.category == 'work' %}selected{% endif %}>Work</option>
                    <option value="personal" {% if filter_form.category == 'personal' %}selected{% endif %}>Personal</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label for="project_desktop" class="form-label">Project</label>
                <select name="project" id="project_desktop" class="form-select">
                    <option value="">All Projects</option>
                    {% for project in all_projects %}
                        <option value="{{ project.pk }}" data-category="{{ project.category }}" {% if project.pk|stringformat:"s" == filter_form.project %}selected{% endif %}>
                            {{ project.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="show_archived" id="show_archived_desktop" value="on" {% if filter_form.show_archived %}checked{% endif %}>
                    <label class="form-check-label" for="show_archived_desktop">
                        Show Archived
                    </label>
                </div>
            </div>
            <div class="col-lg-2">
                <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
        </form>
    </div>
</div>

<!-- Mobile/Tablet Filter (Hidden on LG screens and up) -->
<div class="card mb-4 d-lg-none">
    <div class="card-header" id="filter-heading-mobile">
        <h2 class="mb-0">
            <button class="btn btn-link btn-block text-left text-decoration-none d-flex justify-content-between w-100" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse-mobile" aria-expanded="false" aria-controls="filter-collapse-mobile">
                <span class="h5 mb-0">Filters</span>
                <span class="filter-toggle-icon">+</span>
            </button>
        </h2>
    </div>
    <div id="filter-collapse-mobile" class="collapse">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-12">
                    <label for="start_date_mobile" class="form-label">Start Date</label>
                    <input type="date" name="start_date" id="start_date_mobile" class="form-control" value="{{ filter_form.start_date|default:'' }}">
                </div>
                <div class="col-12">
                    <label for="end_date_mobile" class="form-label">End Date</label>
                    <input type="date" name="end_date" id="end_date_mobile" class="form-control" value="{{ filter_form.end_date|default:'' }}">
                </div>
                <div class="col-12">
                    <label for="category_mobile" class="form-label">Category</label>
                    <select name="category" id="category_mobile" class="form-select">
                        <option value="">All</option>
                        <option value="work" {% if filter_form.category == 'work' %}selected{% endif %}>Work</option>
                        <option value="personal" {% if filter_form.category == 'personal' %}selected{% endif %}>Personal</option>
                    </select>
                </div>
                <div class="col-12">
                    <label for="project_mobile" class="form-label">Project</label>
                    <select name="project" id="project_mobile" class="form-select" 
                            data-latest-work-project="{{ latest_work_project_id|default:'' }}" 
                            data-latest-personal-project="{{ latest_personal_project_id|default:'' }}">
                        <option value="">All Projects</option>
                        {% for project in all_projects %}
                            <option value="{{ project.pk }}" data-category="{{ project.category }}" {% if project.pk|stringformat:"s" == filter_form.project %}selected{% endif %}>
                                {{ project.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="show_archived" id="show_archived_mobile" value="on" {% if filter_form.show_archived %}checked{% endif %}>
                        <label class="form-check-label" for="show_archived_mobile">
                            Show Archived
                        </label>
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form method="get" id="bulk-action-form">
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2 gap-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all-entries">
                    <label class="form-check-label" for="select-all-entries">
                        Select all
                    </label>
                </div>
                <div class="d-flex gap-2">
                    {% if filter_form.show_archived %}
                        <button type="submit" class="btn btn-secondary archive-action-btn" id="bulk-unarchive-btn" disabled formaction="{% url 'tracker:entry_bulk_unarchive_confirm' %}">Unarchive</button>
                    {% else %}
                        <button type="submit" class="btn btn-warning archive-action-btn" id="bulk-archive-btn" disabled formaction="{% url 'tracker:entry_bulk_archive_confirm' %}">Archive</button>
                    {% endif %}
                    <button type="submit" class="btn btn-danger" id="bulk-delete-btn" disabled formaction="{% url 'tracker:entry_bulk_delete_confirm' %}">Delete</button>
                </div>
            </div>
            
            <!-- Table View Container -->
            <div id="table-view-container">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr id="sortable-headers">
                                <th data-column-id="checkbox"></th><!-- Checkbox column -->
                                <th class="text-center" data-column-id="task">
                                    <a href="?{% url_replace request 'sort_by' 'title' 'sort_dir' %}" class="text-decoration-none text-reset">
                                        Task {% if sort_by == 'title' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="duration">
                                     <a href="?{% url_replace request 'sort_by' 'duration' 'sort_dir' %}" class="text-decoration-none text-reset">
                                        Duration {% if sort_by == 'duration' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="date">
                                     <a href="?{% url_replace request 'sort_by' 'start_time' 'sort_dir' %}" class="text-decoration-none text-reset">
                                        Date {% if sort_by == 'start_time' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="project">
                                     <a href="?{% url_replace request 'sort_by' 'project__name' 'sort_dir' %}" class="text-decoration-none text-reset">
                                        Project {% if sort_by == 'project__name' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                                <th class="text-center" data-column-id="start_time">Start Time</th>
                                <th class="text-center" data-column-id="end_time">End Time</th>
                                <th class="text-center" data-column-id="description">Description</th>
                                <th class="text-center" data-column-id="notes">Notes</th>
                                <th class="text-center" data-column-id="image">Image</th>
                                <th class="text-center" data-column-id="category">
                                     <a href="?{% url_replace request 'sort_by' 'category' 'sort_dir' %}" class="text-decoration-none text-reset">
                                        Category {% if sort_by == 'category' %}{% if sort_dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                                    </a>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            {% for entry in entries %}
                            <tr class="{% if entry.is_archived %}table-secondary text-muted{% endif %}">
                                <td class="text-center" data-column-id="checkbox"><input class="form-check-input entry-checkbox" type="checkbox" name="selected_entries" value="{{ entry.pk }}"></td>
                                <td class="text-center" data-column-id="task"><a href="{% url 'tracker:entry_update' entry.pk %}">{{ entry.title }}</a></td>
                                <td class="text-center" data-column-id="duration">{{ entry.duration|human_duration }}</td>
                                <td class="text-center" data-column-id="date">{{ entry.start_time|date:"D j/n/Y" }}</td>
                                <td class="text-center" data-column-id="project">{{ entry.project.name|default:"-" }}</td>
                                <td class="text-center" data-column-id="start_time">{{ entry.start_time|date:"g:i:s A" }}</td>
                                <td class="text-center" data-column-id="end_time">{{ entry.end_time|date:"g:i:s A" }}</td>
                                <td class="text-center" data-column-id="description">{{ entry.description|truncatechars:30|default:"-" }}</td>
                                <td class="text-center" data-column-id="notes">{{ entry.notes|truncatechars:30|default:"-" }}</td>
                                <td class="text-center" data-column-id="image">
                                    {% if entry.image %}
                                        <a href="{{ entry.image.url }}" target="_blank">
                                            <img src="{{ entry.image.url }}" alt="{{ entry.title }} image" style="max-width: 50px; max-height: 50px; object-fit: cover;">
                                        </a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-center" data-column-id="category">{{ entry.get_category_display }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="11" class="text-center">No time entries found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Card View Container -->
            <div id="card-view-container" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3" style="display: none;">
                {% for entry in entries %}
                <div class="col">
                    <div class="card h-100 {% if entry.is_archived %}bg-light text-muted{% endif %}">
                        {% with entry.images.first as first_image %}
                            {% if first_image %}
                                <a href="{{ first_image.image.url }}" target="_blank">
                                    <img src="{{ first_image.image.url }}" class="card-img-top" alt="{{ entry.title }} image" style="height: 180px; object-fit: cover;">
                                </a>
                            {% endif %}
                        {% endwith %}
                        <div class="card-header d-flex justify-content-between align-items-start">
                            <input class="form-check-input entry-checkbox mt-1" type="checkbox" name="selected_entries" value="{{ entry.pk }}">
                            <a href="{% url 'tracker:entry_update' entry.pk %}" class="text-decoration-none text-reset flex-grow-1 ms-2">
                                <h5 class="mb-0">{{ entry.title }}</h5>
                            </a>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <strong>Project:</strong> {{ entry.project.name|default:"-" }}<br>
                                <strong>Category:</strong> {{ entry.get_category_display }}
                            </p>
                            {% if entry.description %}
                                <p class="card-text small"><strong>Description:</strong> {{ entry.description|truncatechars:100 }}</p>
                            {% endif %}
                            {% if entry.notes %}
                                <p class="card-text small"><strong>Notes:</strong> {{ entry.notes|truncatechars:100 }}</p>
                            {% endif %}
                            <p class="card-text small text-muted">
                                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-calendar-event me-1" viewBox="0 0 16 16"><path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/></svg>
                                {{ entry.start_time|date:"D, j M Y" }}
                                <br>
                                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-clock me-1" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0"/></svg>
                                {{ entry.start_time|date:"g:i:s A" }} - {{ entry.end_time|date:"g:i:s A" }}
                                  |  <span class="badge bg-secondary">{{ entry.duration|human_duration }}</span>
                            </p>
                        </div>
                    </div>
                </div>
                {% empty %}
                    <div class="col-12">
                        <p class="text-center">No time entries found.</p>
                    </div>
                {% endfor %}
            </div>

        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<style>
/* --- Existing Table Styles (Preserved) --- */
.table td, .table thead th {
    vertical-align: middle; /* Vertically center all header and cell content */
}

.table thead th:first-child {
    padding: 0; /* Remove padding from the empty checkbox header cell */
}
/* Columns that should not wrap */
.table th:nth-child(2), .table td:nth-child(2), /* Title */
.table th:nth-child(3), .table td:nth-child(3), /* Project */
.table th:nth-child(6), .table td:nth-child(6), /* Image */
.table th:nth-child(7), .table td:nth-child(7), /* Date */
.table th:nth-child(8), .table td:nth-child(8), /* Start Time */
.table th:nth-child(9), .table td:nth-child(9), /* End Time */
.table th:nth-child(10), .table td:nth-child(10), /* Duration */
.table th:nth-child(11), .table td:nth-child(11) /* Category */
{
    white-space: nowrap;
}
/* Columns that can wrap but have a minimum width */
.table th:nth-child(4), .table td:nth-child(4), /* Description */
.table th:nth-child(5), .table td:nth-child(5)  /* Notes */
{
    min-width: 200px;
}

/* --- New Filter Button Styles --- */
.btn-link {
    color: var(--bs-body-color);
    padding: 0;
}
.btn-link:focus, .btn-link:hover {
    color: var(--bs-body-color);
}
.filter-toggle-icon {
    font-size: 1.5rem;
    font-weight: 300;
    line-height: 1;
    transition: transform 0.2s ease-in-out;
}
.card-header [aria-expanded="true"] .filter-toggle-icon {
    transform: rotate(45deg);
}

/* --- Action Button Width Fix --- */
.archive-action-btn {
    min-width: 95px; /* Ensures both Archive and Unarchive buttons have the same width */
    text-align: center;
}

/* --- Mobile Bulk Action Button Styles --- */
@media (max-width: 575.98px) {
    #bulk-action-form .btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }
}

.table th:hover {
    cursor: grab;
}
.table th a {
    color: inherit;
    text-decoration: none;
}
.table th a:hover {
    color: inherit;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Column Reordering & Persistence ---
    const headerRow = document.getElementById('sortable-headers');
    const tableBody = document.getElementById('table-body');
    const storageKey = 'timeEntryTableColumnOrder';

    // Function to apply a specific column order
    function applyColumnOrder(order) {
        if (!order || !tableBody) return;
        
        const headers = Array.from(headerRow.children);
        const newHeaderOrder = order.map(id => headers.find(h => h.dataset.columnId === id));
        headerRow.replaceChildren(...newHeaderOrder);

        Array.from(tableBody.rows).forEach(row => {
            if (row.children.length > 1) { // Skip the "No entries found" row
                const cells = Array.from(row.children);
                const newCellOrder = order.map(id => cells.find(c => c.dataset.columnId === id));
                row.replaceChildren(...newCellOrder);
            }
        });
    }

    // Load and apply saved order on page load
    const savedOrder = JSON.parse(localStorage.getItem(storageKey));
    if (savedOrder) {
        applyColumnOrder(savedOrder);
    }

    // Initialize SortableJS for drag-and-drop
    if (headerRow) {
        new Sortable(headerRow, {
            animation: 150,
            onEnd: function () {
                const newOrder = Array.from(this.el.children).map(th => th.dataset.columnId);
                localStorage.setItem(storageKey, JSON.stringify(newOrder));
                applyColumnOrder(newOrder);
            }
        });
    }

    // --- View Toggler ---
    const tableViewBtn = document.getElementById('table-view-btn');
    const cardViewBtn = document.getElementById('card-view-btn');
    const tableContainer = document.getElementById('table-view-container');
    const cardContainer = document.getElementById('card-view-container');

    function setView(view) {
        if (view === 'card') {
            tableContainer.style.display = 'none';
            cardContainer.style.display = 'flex'; // Use flex for proper row wrapping
            tableViewBtn.classList.remove('active');
            cardViewBtn.classList.add('active');
            localStorage.setItem('timeEntryView', 'card');
        } else {
            tableContainer.style.display = 'block';
            cardContainer.style.display = 'none';
            tableViewBtn.classList.add('active');
            cardViewBtn.classList.remove('active');
            localStorage.setItem('timeEntryView', 'table');
        }
    }

    tableViewBtn.addEventListener('click', () => setView('table'));
    cardViewBtn.addEventListener('click', () => setView('card'));

    // Restore user's preferred view on page load, or set default based on screen size
    const preferredView = localStorage.getItem('timeEntryView');
    if (preferredView) {
        setView(preferredView);
    } else {
        // If no preference is stored, default to card view on smaller screens (Bootstrap's lg breakpoint)
        if (window.innerWidth < 992) {
            setView('card');
        } else {
            setView('table'); // Default to table view on larger screens
        }
    }

    // --- Desktop Project Filter Logic ---
    const desktopCategorySelect = document.getElementById('category_desktop');
    const desktopProjectSelect = document.getElementById('project_desktop');

    if (desktopCategorySelect && desktopProjectSelect) {
        const desktopProjectOptions = Array.from(desktopProjectSelect.options);

        function filterDesktopProjects() {
            const selectedCategory = desktopCategorySelect.value;
            const currentProject = desktopProjectSelect.value;

            desktopProjectOptions.forEach(option => {
                if (option.value === "" || selectedCategory === "" || option.dataset.category === selectedCategory) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });

            const selectedOption = desktopProjectSelect.querySelector(`option[value="${currentProject}"]`);
            if (selectedOption && selectedOption.style.display === 'none') {
                desktopProjectSelect.value = '';
            }
        }

        desktopCategorySelect.addEventListener('change', filterDesktopProjects);
        filterDesktopProjects(); // Initial filter on page load
    }

    // --- Mobile Project Filter Logic ---
    const mobileCategorySelect = document.getElementById('category_mobile');
    const mobileProjectSelect = document.getElementById('project_mobile');

    if (mobileCategorySelect && mobileProjectSelect) {
        const mobileProjectOptions = Array.from(mobileProjectSelect.options);

        function filterMobileProjects() {
            const selectedCategory = mobileCategorySelect.value;
            const currentProject = mobileProjectSelect.value;

            mobileProjectOptions.forEach(option => {
                if (option.value === "" || selectedCategory === "" || option.dataset.category === selectedCategory) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });

            // If the currently selected project is now hidden, reset to "All Projects"
            const selectedOption = mobileProjectSelect.querySelector(`option[value="${currentProject}"]`);
            if (selectedOption && selectedOption.style.display === 'none') {
                mobileProjectSelect.value = '';
            }
        }

        mobileCategorySelect.addEventListener('change', filterMobileProjects);
        // Initial filter on page load to hide projects that don't match the initial category
        filterMobileProjects();
    }

    // --- Mobile Filter Icon Toggle ---
    const filterCollapseElement = document.getElementById('filter-collapse-mobile');
    if (filterCollapseElement) {
        const toggleIcon = document.querySelector('.filter-toggle-icon');
        filterCollapseElement.addEventListener('show.bs.collapse', function () {
            toggleIcon.textContent = '−'; // Minus sign
        });
        filterCollapseElement.addEventListener('hide.bs.collapse', function () {
            toggleIcon.textContent = '+';
        });
    }

    // --- Bulk Action Logic ---
    const selectAllCheckbox = document.getElementById('select-all-entries');
    // Select checkboxes from both views
    const entryCheckboxes = document.querySelectorAll('.entry-checkbox');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const bulkArchiveBtn = document.getElementById('bulk-archive-btn');
    const bulkUnarchiveBtn = document.getElementById('bulk-unarchive-btn');
    const bulkActionForm = document.getElementById('bulk-action-form');

    function toggleBulkActionButtons() {
        const anyChecked = Array.from(entryCheckboxes).some(cb => cb.checked);
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = !anyChecked;
        if (bulkArchiveBtn) bulkArchiveBtn.disabled = !anyChecked;
        if (bulkUnarchiveBtn) bulkUnarchiveBtn.disabled = !anyChecked;
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            entryCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            toggleBulkActionButtons();
        });
    }

    entryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (!this.checked) {
                selectAllCheckbox.checked = false;
            } else {
                const allChecked = Array.from(entryCheckboxes).every(cb => cb.checked);
                if (allChecked) {
                    selectAllCheckbox.checked = true;
                }
            }
            toggleBulkActionButtons();
        });
    });

    if (bulkActionForm) {
        bulkActionForm.addEventListener('submit', function(e) {
            const anyChecked = Array.from(entryCheckboxes).some(cb => cb.checked);
            if (!anyChecked) {
                e.preventDefault();
                alert('Please select at least one entry.');
                return;
            }
        });
    }

    toggleBulkActionButtons(); // Initial check on page load
});
</script>

{% endblock %}
