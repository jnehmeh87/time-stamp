{% extends "base.html" %}
{% load tracker_tags %}

{% block title %}My Time Entries{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>My Time Entries</h1>
</div>

<!-- Desktop Filter (Visible on LG screens and up) -->
<div class="card mb-4 d-none d-lg-block">
    <div class="card-header">Filters</div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-lg-3">
                <label for="start_date_desktop" class="form-label">Start Date</label>
                <input type="date" name="start_date" id="start_date_desktop" class="form-control" value="{{ filter_form.start_date|default:'' }}">
            </div>
            <div class="col-lg-3">
                <label for="end_date_desktop" class="form-label">End Date</label>
                <input type="date" name="end_date" id="end_date_desktop" class="form-control" value="{{ filter_form.end_date|default:'' }}">
            </div>
            <div class="col-lg-2">
                <label for="category_desktop" class="form-label">Category</label>
                <select name="category" id="category_desktop" class="form-select">
                    <option value="">All</option>
                    <option value="work" {% if filter_form.category == 'work' %}selected{% endif %}>Work</option>
                    <option value="personal" {% if filter_form.category == 'personal' %}selected{% endif %}>Personal</option>
                </select>
            </div>
            <div class="col-lg-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="show_archived" id="show_archived_desktop" value="on" {% if filter_form.show_archived %}checked{% endif %}>
                    <label class="form-check-label" for="show_archived_desktop">
                        Show Archived
                    </label>
                </div>
            </div>
            <div class="col-lg-2">
                <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
        </form>
    </div>
</div>

<!-- Mobile/Tablet Filter (Hidden on LG screens and up) -->
<div class="card mb-4 d-lg-none">
    <div class="card-header" id="filter-heading-mobile">
        <h2 class="mb-0">
            <button class="btn btn-link btn-block text-left text-decoration-none d-flex justify-content-between w-100" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse-mobile" aria-expanded="false" aria-controls="filter-collapse-mobile">
                <span class="h5 mb-0">Filters</span>
                <span class="filter-toggle-icon">+</span>
            </button>
        </h2>
    </div>
    <div id="filter-collapse-mobile" class="collapse">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-12">
                    <label for="start_date_mobile" class="form-label">Start Date</label>
                    <input type="date" name="start_date" id="start_date_mobile" class="form-control" value="{{ filter_form.start_date|default:'' }}">
                </div>
                <div class="col-12">
                    <label for="end_date_mobile" class="form-label">End Date</label>
                    <input type="date" name="end_date" id="end_date_mobile" class="form-control" value="{{ filter_form.end_date|default:'' }}">
                </div>
                <div class="col-12">
                    <label for="category_mobile" class="form-label">Category</label>
                    <select name="category" id="category_mobile" class="form-select">
                        <option value="">All</option>
                        <option value="work" {% if filter_form.category == 'work' %}selected{% endif %}>Work</option>
                        <option value="personal" {% if filter_form.category == 'personal' %}selected{% endif %}>Personal</option>
                    </select>
                </div>
                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="show_archived" id="show_archived_mobile" value="on" {% if filter_form.show_archived %}checked{% endif %}>
                        <label class="form-check-label" for="show_archived_mobile">
                            Show Archived
                        </label>
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form method="get" id="bulk-action-form">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2 gap-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all-entries">
                    <label class="form-check-label" for="select-all-entries">
                        Select all
                    </label>
                </div>
                <div class="d-flex gap-2">
                    {% if filter_form.show_archived %}
                        <button type="submit" class="btn btn-secondary archive-action-btn" id="bulk-unarchive-btn" disabled formaction="{% url 'tracker:entry_bulk_unarchive_confirm' %}">Unarchive</button>
                    {% else %}
                        <button type="submit" class="btn btn-warning archive-action-btn" id="bulk-archive-btn" disabled formaction="{% url 'tracker:entry_bulk_archive_confirm' %}">Archive</button>
                    {% endif %}
                    <button type="submit" class="btn btn-danger" id="bulk-delete-btn" disabled formaction="{% url 'tracker:entry_bulk_delete_confirm' %}">Delete</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th></th><!-- Checkbox column -->
                            <th>Title</th>
                            <th>Project</th>
                            <th>Description</th>
                            <th>Notes</th>
                            <th>Image</th>
                            <th>Date</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in entries %}
                        <tr class="{% if entry.is_archived %}table-secondary text-muted{% endif %}">
                            <td><input class="form-check-input entry-checkbox" type="checkbox" name="selected_entries" value="{{ entry.pk }}"></td>
                            <td><a href="{% url 'tracker:entry_update' entry.pk %}">{{ entry.title }}</a></td>
                            <td>{{ entry.project.name|default:"-" }}</td>
                            <td>{{ entry.description|truncatechars:30|default:"-" }}</td>
                            <td>{{ entry.notes|truncatechars:30|default:"-" }}</td>
                            <td>
                                {% if entry.image %}
                                    <a href="{{ entry.image.url }}" target="_blank">
                                        <img src="{{ entry.image.url }}" alt="{{ entry.title }} image" style="max-width: 50px; max-height: 50px; object-fit: cover;">
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ entry.start_time|date:"D j/n/Y" }}</td>
                            <td>{{ entry.start_time|date:"g:i:s A" }}</td>
                            <td>{{ entry.end_time|date:"g:i:s A" }}</td>
                            <td>{{ entry.duration|human_duration }}</td>
                            <td>{{ entry.get_category_display }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center">No time entries found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<style>
/* --- Existing Table Styles (Preserved) --- */
.table td, .table thead th {
    vertical-align: middle; /* Vertically center all header and cell content */
}

.table thead th:first-child {
    padding: 0; /* Remove padding from the empty checkbox header cell */
}
/* Columns that should not wrap */
.table th:nth-child(2), .table td:nth-child(2), /* Title */
.table th:nth-child(3), .table td:nth-child(3), /* Project */
.table th:nth-child(6), .table td:nth-child(6), /* Image */
.table th:nth-child(7), .table td:nth-child(7), /* Date */
.table th:nth-child(8), .table td:nth-child(8), /* Start Time */
.table th:nth-child(9), .table td:nth-child(9), /* End Time */
.table th:nth-child(10), .table td:nth-child(10), /* Duration */
.table th:nth-child(11), .table td:nth-child(11) /* Category */
{
    white-space: nowrap;
}
/* Columns that can wrap but have a minimum width */
.table th:nth-child(4), .table td:nth-child(4), /* Description */
.table th:nth-child(5), .table td:nth-child(5)  /* Notes */
{
    min-width: 200px;
}

/* --- New Filter Button Styles --- */
.btn-link {
    color: var(--bs-body-color);
    padding: 0;
}
.btn-link:focus, .btn-link:hover {
    color: var(--bs-body-color);
}
.filter-toggle-icon {
    font-size: 1.5rem;
    font-weight: 300;
    line-height: 1;
    transition: transform 0.2s ease-in-out;
}
.card-header [aria-expanded="true"] .filter-toggle-icon {
    transform: rotate(45deg);
}

/* --- Action Button Width Fix --- */
.archive-action-btn {
    min-width: 95px; /* Ensures both Archive and Unarchive buttons have the same width */
    text-align: center;
}

/* --- Mobile Bulk Action Button Styles --- */
@media (max-width: 575.98px) {
    #bulk-action-form .btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Mobile Filter Icon Toggle ---
    const filterCollapseElement = document.getElementById('filter-collapse-mobile');
    if (filterCollapseElement) {
        const toggleIcon = document.querySelector('.filter-toggle-icon');
        filterCollapseElement.addEventListener('show.bs.collapse', function () {
            toggleIcon.textContent = '−'; // Minus sign
        });
        filterCollapseElement.addEventListener('hide.bs.collapse', function () {
            toggleIcon.textContent = '+';
        });
    }

    // --- Bulk Action Logic (Preserved) ---
    const selectAllCheckbox = document.getElementById('select-all-entries');
    const entryCheckboxes = document.querySelectorAll('.entry-checkbox');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const bulkArchiveBtn = document.getElementById('bulk-archive-btn');
    const bulkUnarchiveBtn = document.getElementById('bulk-unarchive-btn');
    const bulkActionForm = document.getElementById('bulk-action-form');

    function toggleBulkActionButtons() {
        const anyChecked = Array.from(entryCheckboxes).some(cb => cb.checked);
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = !anyChecked;
        if (bulkArchiveBtn) bulkArchiveBtn.disabled = !anyChecked;
        if (bulkUnarchiveBtn) bulkUnarchiveBtn.disabled = !anyChecked;
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            entryCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            toggleBulkActionButtons();
        });
    }

    entryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (!this.checked) {
                selectAllCheckbox.checked = false;
            } else {
                const allChecked = Array.from(entryCheckboxes).every(cb => cb.checked);
                if (allChecked) {
                    selectAllCheckbox.checked = true;
                }
            }
            toggleBulkActionButtons();
        });
    });

    if (bulkActionForm) {
        bulkActionForm.addEventListener('submit', function(e) {
            const anyChecked = Array.from(entryCheckboxes).some(cb => cb.checked);
            if (!anyChecked) {
                e.preventDefault();
                alert('Please select at least one entry.');
                return;
            }
        });
    }

    toggleBulkActionButtons(); // Initial check on page load
});
</script>

<!-- THE FIX: This script enables Bootstrap's interactive components -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
{% endblock %}
