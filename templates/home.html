{% extends "base.html" %}

{% block title %}Dashboard - Time Stamp App{% endblock %}

{% block content %}
{% if user.is_authenticated %}
    <div class="text-center">
        <div class="card mx-auto" style="max-width: 500px;">
            <div class="card-body p-4">
                <h2 class="card-title mb-3">Time Tracker</h2>
                {% if active_entry %}
                    <p class="lead">Timer is running for: <strong>{{ active_entry.title }}</strong></p>
                    <p class="text-muted">Project: {{ active_entry.project.name|default:"None" }} | Category: {{ active_entry.get_category_display }}</p>
                    <h1 id="timer" class="display-4 my-3" data-starttime="{{ active_entry.start_time.isoformat }}">00:00:00</h1>
                    <form action="{% url 'tracker:stop_timer' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-lg w-100">Stop Timer</button>
                    </form>
                {% else %}
                    <p class="lead">Start a new time entry.</p>
                    <form action="{% url 'tracker:start_timer' %}" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <input type="text" name="title" class="form-control" placeholder="What are you working on?" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="project" class="form-label">Project</label>
                                <div class="input-group">
                                    <select name="project" id="project" class="form-select">
                                        <option value="">No Project</option>
                                        {% for project in projects %}
                                        <option value="{{ project.pk }}" data-category="{{ project.category }}" {% if project.pk|stringformat:"s" == new_project_id %}selected{% endif %}>{{ project.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <a href="{% url 'tracker:project_create' %}?next={{ request.path }}" class="btn btn-outline-secondary" role="button">+</a>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category</label>
                                <div class="d-flex">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="category" id="category_work" value="work" {% if new_category == 'work' or not new_category %}checked{% endif %}>
                                        <label class="form-check-label" for="category_work">Work</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="category" id="category_personal" value="personal" {% if new_category == 'personal' %}checked{% endif %}>
                                        <label class="form-check-label" for="category_personal">Personal</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success btn-lg w-100">Start Timer</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    {% if active_entry %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                const startTime = new Date(timerElement.dataset.starttime);

                function updateTimer() {
                    const now = new Date();
                    const difference = now - startTime;

                    const hours = String(Math.floor(difference / 3600000)).padStart(2, '0');
                    const minutes = String(Math.floor((difference % 3600000) / 60000)).padStart(2, '0');
                    const seconds = String(Math.floor((difference % 60000) / 1000)).padStart(2, '0');

                    timerElement.textContent = `${hours}:${minutes}:${seconds}`;
                }

                setInterval(updateTimer, 1000);
                updateTimer(); // Initial call to display timer immediately
            }
        });
    </script>
    {% endif %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const categoryRadios = document.querySelectorAll('input[name="category"]');
        const projectSelect = document.getElementById('project');
        const projectOptions = Array.from(projectSelect.options);

        function filterProjects() {
            const selectedCategory = document.querySelector('input[name="category"]:checked').value;
            let currentProjectValue = projectSelect.value;

            projectOptions.forEach(option => {
                if (option.value === "") { // Always show "No Project"
                    option.style.display = '';
                } else if (option.dataset.category === selectedCategory) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });

            // If the currently selected project is now hidden, reset to "No Project"
            const selectedOption = projectSelect.querySelector(`option[value="${currentProjectValue}"]`);
            if (selectedOption && selectedOption.style.display === 'none') {
                projectSelect.value = '';
            }
        }

        categoryRadios.forEach(radio => {
            radio.addEventListener('change', filterProjects);
        });

        // Initial filter on page load
        filterProjects();
    });
    </script>

{% else %}
    {# This block is for unauthenticated users, as before. #}
    <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-5">
            <h1 class="display-5 fw-bold">Welcome to TimeStamp</h1>
            <p class="col-md-8 fs-4">Your personal time tracking assistant. Click, track, and manage your time effectively.</p>
            <a href="{% url 'account_signup' %}" class="btn btn-primary btn-lg">Get Started</a>
        </div>
    </div>
{% endif %}
{% endblock %}
